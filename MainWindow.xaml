<Window x:Class="Zvonilka.MainWindow"
        xmlns="http://schemas.microsoft.com/winfx/2006/xaml/presentation"
        xmlns:x="http://schemas.microsoft.com/winfx/2006/xaml"
        xmlns:materialDesign="http://materialdesigninxaml.net/winfx/xaml/themes"
        Title="Звонилка - Голосовой и текстовый чат"
        Width="800"
        Height="600"
        MinWidth="600"
        MinHeight="400"
        Background="{StaticResource PrimaryBackgroundBrush}"
        Foreground="{StaticResource TextPrimaryBrush}">

    <Grid>
        <Grid.RowDefinitions>
            <RowDefinition Height="Auto"/>
            <RowDefinition Height="*"/>
        </Grid.RowDefinitions>

        <!-- Header -->
        <materialDesign:Card Grid.Row="0" Margin="5" Padding="8">
            <Grid>
                <Grid.ColumnDefinitions>
                    <ColumnDefinition Width="Auto"/>
                    <ColumnDefinition Width="*"/>
                    <ColumnDefinition Width="Auto"/>
                </Grid.ColumnDefinitions>

                <!-- App Title -->
                <StackPanel Grid.Column="0" Orientation="Horizontal" Margin="0,0,10,0">
                    <materialDesign:PackIcon Kind="Phone" Width="20" Height="20"
                                           Foreground="{StaticResource PrimaryAccentBrush}"
                                           VerticalAlignment="Center" Margin="0,0,5,0"/>
                    <TextBlock Text="Zvonilka" FontSize="16" FontWeight="Bold"
                             VerticalAlignment="Center" Foreground="{StaticResource TextPrimaryBrush}"/>
                </StackPanel>

                <!-- Server Settings -->
                <StackPanel Grid.Column="1" Orientation="Horizontal" HorizontalAlignment="Center" Width="391">
                    <TextBlock Text="Сервер:" FontSize="12" VerticalAlignment="Center" Margin="0,0,5,0" Width="47"/>
                    <TextBox Text="{Binding ServerIp}" Width="121" MinWidth="70" MaxWidth="120"
                           materialDesign:HintAssist.Hint="IP" FontSize="12" Margin="0,0,5,0"/>
                    <TextBox Text="{Binding ServerPort}" Width="50" MinWidth="40"
                           materialDesign:HintAssist.Hint="Порт" FontSize="12"/>
                    <Button Content="{Binding IsConnected, Converter={StaticResource BoolToConnectConverter}}"
                           Command="{Binding ConnectCommand}" Style="{StaticResource MaterialDesignRaisedButton}"
                           Background="{Binding IsConnected, Converter={StaticResource BoolToBrushConverter}}"
                           FontSize="12" Padding="8,2" MinWidth="80"/>
                </StackPanel>

                <!-- Controls -->
                <StackPanel Grid.Column="2" Orientation="Horizontal">
                    <!-- Microphone Toggle -->
                    <ToggleButton IsChecked="{Binding IsMuted}" Command="{Binding ToggleMuteCommand}"
                                Style="{StaticResource MaterialDesignActionToggleButton}"
                                ToolTip="Отключить микрофон" Width="28" Height="28" Margin="0,0,5,0">
                        <materialDesign:PackIcon Width="14" Height="14"
                            Kind="{Binding IsMuted, Converter={StaticResource BoolToMicIconConverter}}"
                            Foreground="{StaticResource PrimaryAccentBrush}"/>
                    </ToggleButton>

                    <!-- Headphones/Sound Toggle -->
                    <ToggleButton IsChecked="{Binding IsDeafened}" Command="{Binding ToggleDeafenCommand}"
                                Style="{StaticResource MaterialDesignActionToggleButton}"
                                ToolTip="Отключить звук" Width="28" Height="28" Margin="0,0,5,0">
                        <materialDesign:PackIcon Width="14" Height="14"
                            Kind="{Binding IsDeafened, Converter={StaticResource BoolToHeadphoneIconConverter}}"
                            Foreground="{StaticResource PrimaryAccentBrush}"/>
                    </ToggleButton>

                    <!-- Settings -->
                    <Button Command="{Binding OpenSettingsCommand}"
                           Style="{StaticResource MaterialDesignIconButton}"
                           ToolTip="Настройки" Width="28" Height="28">
                        <materialDesign:PackIcon Kind="Cog" Width="14" Height="14"/>
                    </Button>
                </StackPanel>
            </Grid>
        </materialDesign:Card>

        <!-- Main Content -->
        <Grid Grid.Row="1" Margin="5">
            <Grid.ColumnDefinitions>
                <ColumnDefinition Width="200"/>
                <ColumnDefinition Width="Auto"/>
                <ColumnDefinition Width="*"/>
                <ColumnDefinition Width="Auto"/>
                <ColumnDefinition Width="180"/>
            </Grid.ColumnDefinitions>

            <!-- Rooms Panel -->
            <materialDesign:Card Grid.Column="0">
                <Grid>
                    <Grid.RowDefinitions>
                        <RowDefinition Height="Auto"/>
                        <RowDefinition Height="*"/>
                    </Grid.RowDefinitions>
                    <StackPanel Orientation="Horizontal" Margin="8,5">
                        <TextBlock Text="Комнаты" FontSize="13" FontWeight="Bold"/>
                        <Button Command="{Binding CreateRoomCommand}" Style="{StaticResource MaterialDesignIconButton}"
                               Margin="5,0,0,0" ToolTip="Создать комнату" Width="22" Height="22">
                            <materialDesign:PackIcon Kind="Plus" Width="12" Height="12"/>
                        </Button>
                    </StackPanel>
                    <ListBox Grid.Row="1" ItemsSource="{Binding AvailableRooms}" Margin="5"
                           BorderThickness="0" Background="Transparent"
                           ScrollViewer.HorizontalScrollBarVisibility="Disabled">
                        <ListBox.ItemTemplate>
                            <DataTemplate>
                                <materialDesign:Card Margin="0,2" Padding="6" MinWidth="150">
                                    <Grid>
                                        <Grid.RowDefinitions>
                                            <RowDefinition Height="Auto"/>
                                            <RowDefinition Height="Auto"/>
                                        </Grid.RowDefinitions>
                                        <TextBlock Text="{Binding Name}" FontWeight="Bold" FontSize="11"/>
                                        <StackPanel Grid.Row="1" Orientation="Horizontal" Margin="0,2,0,0">
                                            <materialDesign:PackIcon Kind="AccountGroup" Width="10" Height="10" Margin="0,0,2,0"/>
                                            <TextBlock Text="{Binding Members.Count}" FontSize="10"
                                                     Foreground="{StaticResource TextSecondaryBrush}"/>
                                            <materialDesign:PackIcon Kind="Lock" Width="10" Height="10" Margin="5,0,0,0"
                                                                   Visibility="{Binding IsPrivate, Converter={StaticResource BoolToVisibilityConverter}}"/>
                                        </StackPanel>
                                    </Grid>
                                </materialDesign:Card>
                            </DataTemplate>
                        </ListBox.ItemTemplate>
                    </ListBox>
                </Grid>
            </materialDesign:Card>

            <!-- GridSplitter between Rooms and Chat -->
            <GridSplitter Grid.Column="1" Width="4" HorizontalAlignment="Center"
                          Background="{StaticResource MaterialDesignDivider}"
                          ResizeBehavior="PreviousAndNext"/>

            <!-- Chat Area -->
            <Grid Grid.Column="2">
                <Grid.RowDefinitions>
                    <RowDefinition Height="*"/>
                    <RowDefinition Height="Auto"/>
                </Grid.RowDefinitions>

                <!-- Messages -->
                <materialDesign:Card Grid.Row="0" Margin="0,0,3,0">
                    <ListBox ItemsSource="{Binding Messages}" Margin="5"
                           BorderThickness="0" Background="Transparent"
                           ScrollViewer.HorizontalScrollBarVisibility="Disabled"
                           VerticalContentAlignment="Stretch">
                        <ListBox.ItemTemplate>
                            <DataTemplate>
                                <materialDesign:Card Margin="0,2" Padding="6" MaxWidth="500">
                                    <Grid>
                                        <Grid.RowDefinitions>
                                            <RowDefinition Height="Auto"/>
                                            <RowDefinition Height="Auto"/>
                                        </Grid.RowDefinitions>
                                        <StackPanel Orientation="Horizontal">
                                            <Border CornerRadius="50" Width="20" Height="20" Margin="0,0,5,0">
                                                <Border.Style>
                                                    <Style TargetType="Border">
                                                        <Style.Triggers>
                                                            <DataTrigger Binding="{Binding SenderAvatarPath}" Value="{x:Null}">
                                                                <Setter Property="Background" Value="LightGray"/>
                                                            </DataTrigger>
                                                            <DataTrigger Binding="{Binding SenderAvatarPath}" Value="">
                                                                <Setter Property="Background" Value="LightGray"/>
                                                            </DataTrigger>
                                                        </Style.Triggers>
                                                        <Setter Property="Background" Value="Transparent"/>
                                                    </Style>
                                                </Border.Style>
                                                <Image Source="{Binding SenderAvatarPath}" 
                                                       Visibility="{Binding SenderAvatarPath, 
                                                           Converter={StaticResource NullToVisibilityConverter}}"
                                                       Stretch="UniformToFill"/>
                                            </Border>
                                            <TextBlock Text="{Binding SenderName}" FontWeight="Bold" FontSize="11"
                                                     Foreground="{StaticResource PrimaryAccentBrush}"/>
                                            <TextBlock Text="{Binding Timestamp, StringFormat='HH:mm'}"
                                                     FontSize="9" Margin="4,0,0,0"
                                                     Foreground="{StaticResource TextSecondaryBrush}"/>
                                            <materialDesign:PackIcon Kind="Lock" Width="10" Height="10" Margin="3,0,0,0"
                                                                   Visibility="{Binding IsPrivate, Converter={StaticResource BoolToVisibilityConverter}}"/>
                                        </StackPanel>
                                        <TextBlock Grid.Row="1" Text="{Binding Content}"
                                                 TextWrapping="Wrap" Margin="0,2,0,0" FontSize="12"/>
                                    </Grid>
                                </materialDesign:Card>
                            </DataTemplate>
                        </ListBox.ItemTemplate>
                    </ListBox>
                </materialDesign:Card>

                <!-- Message Input -->
                <materialDesign:Card Grid.Row="1" Margin="0,5,3,0" Padding="8">
                    <Grid>
                        <Grid.ColumnDefinitions>
                            <ColumnDefinition Width="*"/>
                            <ColumnDefinition Width="Auto"/>
                        </Grid.ColumnDefinitions>

                        <TextBox Grid.Column="0" Text="{Binding MessageText}"
                               materialDesign:HintAssist.Hint="Сообщение..."
                               VerticalContentAlignment="Center" Margin="0,0,8,0" FontSize="12"/>

                        <StackPanel Grid.Column="1" Orientation="Horizontal">
                            <Button Command="{Binding SendMessageCommand}"
                                   Style="{StaticResource MaterialDesignIconButton}"
                                   ToolTip="Отправить" Width="32" Height="32">
                                <materialDesign:PackIcon Kind="Send" Width="16" Height="16"/>
                            </Button>

                            <Button Command="{Binding SendFileCommand}"
                                   Style="{StaticResource MaterialDesignIconButton}"
                                   ToolTip="Файл" Width="32" Height="32" Margin="2,0">
                                <materialDesign:PackIcon Kind="Paperclip" Width="14" Height="14"/>
                            </Button>
                            <Button Style="{StaticResource MaterialDesignIconButton}"
                                   ToolTip="Эмодзи" Width="32" Height="32" Margin="2,0">
                                <materialDesign:PackIcon Kind="EmoticonHappy" Width="14" Height="14"/>
                            </Button>
                        </StackPanel>
                    </Grid>
                </materialDesign:Card>
            </Grid>

            <!-- GridSplitter between Chat and Users -->
            <GridSplitter Grid.Column="3" Width="4" HorizontalAlignment="Center"
                          Background="{StaticResource MaterialDesignDivider}"
                          ResizeBehavior="PreviousAndNext"/>

            <!-- Users Panel -->
            <materialDesign:Card Grid.Column="4">
                <Grid>
                    <Grid.RowDefinitions>
                        <RowDefinition Height="Auto"/>
                        <RowDefinition Height="*"/>
                    </Grid.RowDefinitions>
                    <TextBlock Grid.Row="0" Text="Онлайн" FontSize="13" FontWeight="Bold"
                             Margin="10,5" HorizontalAlignment="Center"/>
                    <ListBox Grid.Row="1" ItemsSource="{Binding OnlineUsers}" Margin="5"
                           BorderThickness="0" Background="Transparent">
                        <ListBox.ItemTemplate>
                            <DataTemplate>
                                <Grid Margin="0,2">
                                    <Grid.ColumnDefinitions>
                                        <ColumnDefinition Width="Auto"/>
                                        <ColumnDefinition Width="*"/>
                                        <ColumnDefinition Width="Auto"/>
                                    </Grid.ColumnDefinitions>
                                    <materialDesign:PackIcon Grid.Column="0" Kind="AccountCircle"
                                                           Width="16" Height="16" Margin="0,0,5,0"/>
                                    <TextBlock Grid.Column="1" Text="{Binding Username}"
                                             VerticalAlignment="Center" FontSize="11"/>
                                    <materialDesign:PackIcon Grid.Column="2" Kind="Microphone"
                                                           Foreground="Red" Width="12" Height="12"
                                                           Visibility="{Binding IsMuted, Converter={StaticResource BoolToVisibilityConverter}}"/>
                                </Grid>
                            </DataTemplate>
                        </ListBox.ItemTemplate>
                    </ListBox>
                </Grid>
            </materialDesign:Card>
        </Grid>
    </Grid>
</Window>